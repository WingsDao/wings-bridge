# Wings Bridge

The Wings bridge contract works like communication contract. It allows to notify Wings about new contributions during crowdsale and to automatically send rewards to bridge smart contract.

Wings bridge is based on [custom crowdsale contract and integration](https://github.com/wingsdao/wings-integration).

It makes integration much simpler and easy to do.

## Requirements

- Nodejs v8
- Truffle
- Ganache-cli v6.0.3

# Step by step guide #

### Package install ###

Install this package as dependency for your smart contracts.

```
npm i @wings_platform/wings-bridge --save
```

### Inheritance ###

Inherit your `Crowdsale` contract from `Connector` contract.

```sc
contract Crowdsale is Connector {
```

*NOTE: Connector already inherits from `Ownable` so we don't need to inherit again.*

### Method notifySale ###

Call method `notifySale` when sale/exchange of your token happens.

```sc
notifySale(value, tokensSold);
```
**Parameters:**
  - `value` - amount of funds received in wei.
  - `tokensSold` - tokens amount.

*See how it looks in [example](https://github.com/WingsDao/wings-bridge/blob/master/contracts/examples/crowdsale.sol#L89-L117).*

### Methods calculateRewards and closeBridge ###

1. Implement functionality to calculate and transfer rewards.
2. Call method `closeBridge` when rewards are calculated and transferred.

```sc
uint256 ethReward = 0;
uint256 tokenReward = 0;

(ethReward, tokenReward) = bridge.calculateRewards();

// send rewards
if (ethReward > 0) {
   bridge.transfer(ethReward);
}

if (tokenReward > 0) {
   crowdsaleToken.issue(bridge, tokenReward);
}

// close bridge
closeBridge();
```

`calculateRewards` - call it to get amount of rewards.

**Returns:** rewards amount in ETH and tokens. If you don't have reward in ETH, the returned value ETH reward will be 0.

`closeBridge` - reports to bridge smart contract, when crowdsale is completed.

*See how it looks in [example](https://github.com/WingsDao/wings-bridge/blob/master/contracts/examples/crowdsale.sol#L53-L77).*

### Deploy ###

1. Deploy your token and crowdsale contracts,
2. Deploy bridge contract.
3. Call method `changeBridge` in your crowdsale contract and pass there address of deployed bridge contract.

At this stage no more changes to source code are needed.

We should deploy our contracts right before we start forecasting at Wings platform.

So let's make a migration script, that will deploy token, crowdsale and bridge contracts, and meanwhile set correct ownership logic in our contracts.


Let's require contracts first:

```js
const Crowdsale = artifacts.require('Crowdsale')
const Token = artifacts.require('Token')
const Bridge = artifacts.require('Bridge')
```


Deploying token and crowdsale:

```js
// Deploying token
await deployer.deploy(Token)
const token = await Token.deployed()

// Deploying Crowdsale
await deployer.deploy(Crowdsale, token.address)
const crowdsale = await Crowdsale.deployed()

// Move token owner to crowdsale
await token.transferOwnership(crowdsale.address)
```

Now let's deploy bridge:

```js
await deployer.deploy(Bridge, minimalGoal, hardCap, token.address, crowdsale.address)
const bridge = await Bridge.deployed()
```

- `minimalGoal` - minimal goal in wei, must be greater then 10% of hard cap.
- `hardCap` - hard cap in wei.
- `token.address` - token address.
- `crowdsale.address` - crowdsale address.

And then call to crowdsale to change bridge to deployed one:

```sc
await crowdsale.changeBridge(bridge.address)
```
### Create project ###

Create project at Wings platform as custom contract and provide address of **bridge** contract.

Now we need to create project at Wings platform. We go to [Wings](https://wings.ai), fill project details, and at **Smart contract** tab we need to select __Custom Contract__ and put **Bridge Contract Address** to __Contract address__ field.

Like on image:

![contract address](https://i.imgur.com/myATGnp.png)

### Transfer management ###

Once you've created your project and forecasting started, you need to move bridge manager under control of DAO contract address.

To do it, just take URL of your project, like:

https://wings.ai/project/0x28e7f296570498f1182cf148034e818df723798a

As you see - `0x28e7f296570498f1182cf148034e818df723798a`, it's your DAO contract address. You can check it via parity or some other ethereum clients/tools. Account that you used during project creation at [wings.ai](https://wings.ai) is owner of this smart contract.

So we take this address, and move manager of bridge to this address. We use `transferManager` method for it.

```js
await bridge.transferManager('0x28e7f296570498f1182cf148034e818df723798a')
```

*NOTE: these steps can be made during your forecasting period.*

### Start bridge ###

To accomplish this, you need to call few methods in DAO contract, indeed `createCustomCrowdsale` method and  `start` method in your crowdsale controller contract, that will be generated by `createCustomCrowdsale` call.

Here is [ABI](https://github.com/WingsDao/wings-bridge/tree/master/ABI) for contracts and we recommend to use [truffle contract](https://github.com/trufflesuite/truffle-contract) library to make calls.

**IMPORTANT**: use same account that you used to create project at [wings.ai](https://wings.ai)

Like:

```js
const dao = await DAO.at('0x28e7f296570498f1182cf148034e818df723798a') // change with your DAO address
await dao.createCustomCrowdsale()
```

And:

```js
const ccAddress = await dao.crowdsaleController.call()
const crowdsaleController = await CrowdsaleController.at(ccAddress)
await crowdsaleController.start(0, 0, '0x0')
```

**IMPORTANT**: values like 0, 0, '0x0' work fine only if you are using bridge.

That's it. You can start your crowdsale!

## Developing

We recommend to make pull requests to current repository. Each pull request should be covered with tests.

Fetch current repository, install dependencies:

    npm install

We strongly recommend using [ganache-cli](https://github.com/trufflesuite/ganache-cli) for development to save time and cost.

## Tests

To run tests fetch current repository, install dependencies and run:

    truffle test

## Authors

Wings Stiftung

## License

See in [license file](https://github.com/WingsDao/wings-bridge/blob/master/LICENSE).
